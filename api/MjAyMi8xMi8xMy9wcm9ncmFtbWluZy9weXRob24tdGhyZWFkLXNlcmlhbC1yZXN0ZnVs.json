{"title":"Sending TCP Packets with DSCP in Scapy","date":"2022-12-12T16:00:00.000Z","date_formatted":{"ll":"Dec 13, 2022","L":"12/13/2022","MM-DD":"12-13"},"link":"2022/12/13/programming/python-thread-serial-restful","tags":["python","restful","snippet","thread"],"categories":["networking"],"updated":"2022-12-12T16:00:00.000Z","content":"<figure class=\"highlight python\"><figcaption><span>serial_thread.py</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> serial <span class=\"keyword\">import</span> Serial</span><br><span class=\"line\"><span class=\"keyword\">from</span> threading <span class=\"keyword\">import</span> Thread</span><br><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"><span class=\"keyword\">import</span> time</span><br><span class=\"line\"></span><br><span class=\"line\">port = <span class=\"string\">&#x27;/dev/ttyUSB1&#x27;</span></span><br><span class=\"line\">baud = <span class=\"number\">115200</span></span><br><span class=\"line\"></span><br><span class=\"line\">serial_obj = Serial(port, baud, timeout=<span class=\"number\">120</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">token = <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">headers = &#123;<span class=\"string\">&quot;Authorization&quot;</span>: <span class=\"string\">f&quot;Bearer <span class=\"subst\">&#123;token&#125;</span>&quot;</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">handle_data</span>(<span class=\"params\">data</span>):</span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"built_in\">len</span>(data):</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(data)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">read_from_port</span>(<span class=\"params\">ser: Serial</span>):</span><br><span class=\"line\">    connected = <span class=\"literal\">False</span></span><br><span class=\"line\">    <span class=\"keyword\">while</span> <span class=\"keyword\">not</span> connected:</span><br><span class=\"line\">        connected = <span class=\"literal\">True</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">while</span> <span class=\"literal\">True</span>:</span><br><span class=\"line\">           reading = ser.readline().decode(errors=<span class=\"string\">&#x27;replace&#x27;</span>)</span><br><span class=\"line\">           handle_data(reading)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">req</span>():</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">for</span> _ <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">10</span>):</span><br><span class=\"line\">        r = requests.patch(<span class=\"string\">&#x27;http://&lt;ip&gt;/...&#x27;</span>, headers=headers, json=[&#123;&#125;])</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(r.status_code)</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(r.json())</span><br><span class=\"line\"></span><br><span class=\"line\">        time.sleep(<span class=\"number\">1.5</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">t1 = Thread(target=read_from_port, args=(serial_obj,))</span><br><span class=\"line\">t2 = Thread(target=req)</span><br><span class=\"line\">t1.start()</span><br><span class=\"line\">t2.start()</span><br></pre></td></tr></table></figure>\n<p>ref: <a href=\"https://gist.github.com/a-andreyev/1455f8cc024780188a6687b8399f7015\" target=\"_blank\">https://gist.github.com/a-andreyev/1455f8cc024780188a6687b8399f7015</a></p>\n<h4 id=\"output\">Output<a title=\"#output\" href=\"#output\"></a></h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br></pre></td></tr></table></figure>","prev":{"title":"Sending TCP Packets with DSCP in Scapy","link":"2022/12/13/programming/python-scapy-dscp"},"next":{"title":"IPv6","link":"2022/10/20/networking/ipv6"},"plink":"https://jason19970210.github.io/2022/12/13/programming/python-thread-serial-restful/","reading_time":"149 words in 1 min"}